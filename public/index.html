<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>MCP AI Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        body { background-color: #1e1e1e; color: #d4d4d4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .message { padding: 10px 20px; border-radius: 8px; max-width: 85%; line-height: 1.5; font-size: 0.95em; }
        .user { align-self: flex-end; background-color: #007acc; color: white; }
        .ai { align-self: flex-start; background-color: #252526; border: 1px solid #3e3e42; }
        .system { align-self: center; color: #888; font-size: 0.8em; font-style: italic; background: transparent; border: none; }

        /* --- MARKDOWN STÍLUSOK (Dark Mode) --- */
        .message code { background-color: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9em; }
        .message pre { background-color: #1a1a1a; padding: 15px; border-radius: 5px; overflow-x: auto; border: 1px solid #333; }
        .message pre code { background-color: transparent; padding: 0; color: #9cdcfe; }
        .message p { margin: 5px 0; }
        .message ul, .message ol { margin: 5px 0 5px 20px; padding: 0; }
        .message li { margin-bottom: 5px; }
        .message strong { color: #569cd6; } /* Kékesszürke kiemelés */

        /* Táblázatok formázása */
        .message table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 0.9em; }
        .message th, .message td { border: 1px solid #444; padding: 8px; text-align: left; }
        .message th { background-color: #333; font-weight: bold; }

        /* Engedélykérő kártya */
        .approval-card { align-self: center; background-color: #2d2d30; border: 1px solid #e2b93d; padding: 15px; border-radius: 5px; width: 350px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .approval-title { color: #e2b93d; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .approval-details { font-family: 'Consolas', monospace; font-size: 0.85em; background: #1e1e1e; padding: 10px; margin-bottom: 15px; white-space: pre-wrap; border-radius: 4px; color: #ce9178; overflow-x: hidden; }
        .btn-group { display: flex; gap: 10px; justify-content: flex-end; }
        button { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-yes { background-color: #4caf50; color: white; }
        .btn-no { background-color: #f44336; color: white; }
        .btn-send { background-color: #007acc; color: white; }

        #input-area { padding: 20px; background-color: #252526; display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; padding: 12px; background-color: #3c3c3c; border: 1px solid #3e3e42; color: white; border-radius: 4px; outline: none; font-size: 1em; }
        input:focus { border-color: #007acc; }
    </style>
</head>
<body>

    <div id="chat-container"></div>

    <div id="input-area">
        <input type="text" id="msgInput" placeholder="Írj üzenetet..." autocomplete="off">
        <button onclick="sendMessage()" class="btn-send">Küldés</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const container = document.getElementById('chat-container');
        const input = document.getElementById('msgInput');

        // Marked beállítása (pl. sortörések kezelése)
        marked.use({
            breaks: true, // Enter -> <br>
            gfm: true     // GitHub Flavored Markdown (táblázatokhoz)
        });

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;

            if (type === 'ai' || type === 'system') {
                // 1. Markdown renderelése HTML-lé
                const rawHtml = marked.parse(text);
                // 2. Tisztítás (XSS védelem)
                const cleanHtml = DOMPurify.sanitize(rawHtml);
                div.innerHTML = cleanHtml;
            } else {
                // A User üzenetét hagyjuk sima szövegként a biztonság kedvéért
                div.textContent = text;
            }

            container.appendChild(div);
            // Automatikus görgetés aljára
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        // --- Socket Események ---

        socket.on('ai_message', (msg) => addMessage(msg, 'ai'));
        socket.on('system_message', (msg) => addMessage(msg, 'system'));
        socket.on('user_message', (msg) => addMessage(msg, 'user')); // Visszajátszásnál jöhet

        // Engedélykérés
        socket.on('approval_request', (data) => {
            const card = document.createElement('div');
            card.className = 'approval-card';
            card.innerHTML = `
                <div class="approval-title">
                    <span>⚠️</span> Engedélykérés
                </div>
                <div style="margin-bottom: 5px;"><strong>Szerver:</strong> ${data.serverName}</div>
                <div style="margin-bottom: 5px;"><strong>Tool:</strong> <span style="color: #4ec9b0">${data.toolName}</span></div>
                <div class="approval-details">${JSON.stringify(data.args, null, 2)}</div>
                <div class="btn-group">
                    <button class="btn-no">Elutasít</button>
                    <button class="btn-yes">Engedélyez</button>
                </div>
            `;

            const btnYes = card.querySelector('.btn-yes');
            const btnNo = card.querySelector('.btn-no');

            btnYes.onclick = () => {
                socket.emit('approval_response', true);
                card.remove();
                addMessage(`✅ Engedélyezve: ${data.toolName}`, 'system');
            };
            btnNo.onclick = () => {
                socket.emit('approval_response', false);
                card.remove();
                addMessage(`❌ Elutasítva: ${data.toolName}`, 'system');
            };

            container.appendChild(card);
            container.scrollTop = container.scrollHeight;
        });

        function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // Azonnal kiírjuk a saját üzenetet, nem várjuk meg a szervert
            addMessage(text, 'user');
            socket.emit('user_message', text);
            input.value = '';
        }

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
